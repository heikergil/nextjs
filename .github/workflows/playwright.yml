name: E2E Tests
on:   
    release:
        types: [published]
    workflow_dispatch:

    # Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
   E2E-Tests:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v2
      with:
        node-version: '14.x'

    - name: Cache node_modules
      uses: actions/cache@v3
      id: cache-node-modules
      with:
          path: |
              node_modules
          key: modules-${{ hashFiles('package-lock.json') }}

    - name: Cache Playwright
      uses: actions/cache@v3
      with:
          path: |
              ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('yarn.lock') }}

    - name: Install pakages
      if: steps.cache-node-modules.outputs.cache-hit != 'true'
      run: yarn

    - name: Install Playwright 
      run: npx playwright install --with-deps chromium

    - name: Run Playwright tests
      continue-on-error: true
      env: 
        BASE_URL: ${{ github.event.deployment_status.target_url }}
      run: yarn playwright test
    - uses: actions/upload-artifact@v2
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 3

    # - name: Configure AWS Credentials
    #   uses: aws-actions/configure-aws-credentials@v1
    #   with:
    #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     aws-region: us-east-1

    - name: Deploy static site to AWS
      uses: onramper/action-deploy-aws-static-site@v2.0.0
      with:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        publish_dir: ./playwright-report/



    # - name: Upload to S3
    #   run: |
    #     aws s3 mb s3://test-bucket-hosting-56941823734
    #   env:
    #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     AWS_DEFAULT_REGION: 'us-east-1'


    # - name: Deploy static site to S3 bucket
    #   run: aws s3 sync ./playwright-report/ s3://test-bucket-hosting-56941823734 --delete

    # - name: Setup Pages
    #   uses: actions/configure-pages@v2
    # - name: Upload artifact
    #   uses: actions/upload-pages-artifact@v1
    #   with:
    #     # Upload entire repository
    #     path: playwright-report/
        
    # - name: Deploy to GitHub Pages
    #   id: deployment
    #   uses: actions/deploy-pages@v1
 
 
    

name: E2E Tests
on:
  pull_request:
    types: [labeled]

jobs:
   E2E-Tests:
    timeout-minutes: 30
    if: ${{ github.event.label.name == 'ready' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v2
      with:
        node-version: '18.x'

    - name: Download URL file
      uses: dawidd6/action-download-artifact@v2.26.0
      with:
        workflow: capture_urls.yml
        name: capture_url

    - name: Store preview URL
      id: capture-url
      shell: bash
      run: |
        previewURL=`cat preview_url.txt`
        echo "preview_url=$previewURL" >> $GITHUB_OUTPUT 
    
    - name: Cache Playwright
      uses: actions/cache@v3
      id: playwright-cache
      with:
          path: |
              ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('yarn.lock') }}

    - name: Install playwright
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: yarn add playwright -D -W

    - name: Install playwright dedps
      run: npx playwright install-deps chromium

    - name: Run Playwright tests
      env: 
        BASE_URL: ${{ steps.capture-url.outputs.preview_url }}
      run: yarn test
    - uses: actions/upload-artifact@v2
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 3    
 
 
    
